{% extends "components/Layout/base_pages.html" %}

{% block content_pages %}

<h1 class="text-2xl font-bold mb-6">Lista de Pacientes</h1>

<!-- Formulario de búsqueda por RUN -->
<form method="get" class="mb-4 flex space-x-2">
    <input type="text" 
        name="run" 
        placeholder="(Ej: 12345678-9)" 
        value="{{ run_query }}"
        class="border px-3 py-2 rounded w-1/3"
        pattern="\d{7,8}-[0-9kK]" 
        title="Ingrese un RUN válido (7 a 8 números + DV)">
    
    <!-- Botón Buscar -->
    <button type="submit" 
            class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
        Buscar
    </button>
    
    <!-- Botón Limpiar -->
    <button type="button" 
            onclick="document.querySelector('input[name=run]').value=''; this.form.submit();" 
            class="px-4 py-2 ml-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
        Limpiar
    </button>
</form>



<!-- Botón atrás -->
<div class="mb-6">
    <a href="{% url 'lista_pacientes' %}" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Atrás</a>
</div>

<div x-data="{ selected: null }" class="overflow-x-auto">
    <table class="min-w-full border border-gray-300 text-left">
        <thead class="bg-gray-200">
            <tr>
                <th class="px-4 py-2 border">Nombre completo</th>
                <th class="px-4 py-2 border">RUN</th>
                <th class="px-4 py-2 border">DV</th>
                <th class="px-4 py-2 border">Edad</th>
            </tr>
        </thead>
        <tbody>
            {% for paciente in pacientes %}
                <tr x-show="selected === null || selected === {{ paciente.id }}"
                    class="hover:bg-gray-100 cursor-pointer"
                    @click="selected = selected === {{ paciente.id }} ? null : {{ paciente.id }}">
                    <td class="px-4 py-2 border font-medium">{{ paciente.nombre }} {{ paciente.apellido_paterno }} {{ paciente.apellido_materno }}</td>
                    <td class="px-4 py-2 border">{{ paciente.run }}</td>
                    <td class="px-4 py-2 border">{{ paciente.dv }}</td>
                    <td class="px-4 py-2 border">{{ paciente.edad }}</td>
                </tr>

                <!-- Fila expandida con detalles -->
                <tr x-show="selected === {{ paciente.id }}">
                    <td colspan="4" class="px-4 py-4 border bg-gray-50">
                        <div class="p-4 bg-white border rounded shadow-sm grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div><strong>Nacionalidad:</strong> {{ paciente.nacionalidad }}</div>
                            <div><strong>Inmigrante:</strong> {% if paciente.inmigrante %}Sí{% else %}No{% endif %}</div>
                            <div><strong>Pueblo originario:</strong> {% if paciente.pueblo_originario %}Sí{% else %}No{% endif %}</div>
                            <div><strong>Discapacidad:</strong> {% if paciente.discapacidad %}Sí{% else %}No{% endif %}</div>
                            <div><strong>Privada de libertad:</strong> {% if paciente.privada_libertad %}Sí{% else %}No{% endif %}</div>
                            <div><strong>Trans masculino:</strong> {% if paciente.trans_masculino %}Sí{% else %}No{% endif %}</div>
                            <div><strong>Creado por:</strong> {{ paciente.created_by }}</div>
                            <div><strong>Creado en:</strong> {{ paciente.created_at|date:"d/m/Y H:i" }}</div>
                            <div><strong>Actualizado en:</strong> {{ paciente.updated_at|date:"d/m/Y H:i" }}</div>
                        </div>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td class="px-4 py-2 border text-center" colspan="4">No hay pacientes registrados.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
{% if pacientes.paginator.num_pages > 1 %}
<div class="mt-6 flex justify-center space-x-2">
    {% if pacientes.has_previous %}
        <a href="?page={{ pacientes.previous_page_number }}{% if run_query %}&run={{ run_query }}{% endif %}"
           class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Anterior</a>
    {% endif %}

    <span class="px-3 py-1 bg-gray-200 rounded">
        Página {{ pacientes.number }} de {{ pacientes.paginator.num_pages }}
    </span>

    {% if pacientes.has_next %}
        <a href="?page={{ pacientes.next_page_number }}{% if run_query %}&run={{ run_query }}{% endif %}"
           class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Siguiente</a>
    {% endif %}
</div>
{% else %}
<div class="mt-6 flex justify-center">
    <span class="px-3 py-1 bg-gray-200 rounded">Página 1 de 1</span>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

{% endblock %}
